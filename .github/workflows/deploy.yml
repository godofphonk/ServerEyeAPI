# Copyright (c) 2026 godofphonk
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

name: Build and Deploy

on:
  push:
    branches: [ master, production ]
  pull_request:
    branches: [ master, production ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: godofphonk/servereyeapi

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        
    - name: Cache Go modules
      uses: actions/cache@v5
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Run tests
      run: go test -v ./...
      
    - name: Build
      run: make build

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/production'
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        clean: true
        
    - name: Set BUILD_DATE and VERSION
      run: |
        echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
        echo "VERSION=${{ github.sha }}" >> $GITHUB_ENV
        echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
        
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push Docker image
      run: |
        # Create unique tag
        UNIQUE_TAG="production-${{ github.sha }}-$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
        echo "Building with unique tag: $UNIQUE_TAG"
        
        # Force clean everything
        echo "=== Cleaning git repository ==="
        git clean -fdx
        git reset --hard HEAD
        git fetch --all --prune
        
        # Verify our changes exist
        echo "=== Verifying test changes ==="
        if ! grep -q "CI/CD TEST" internal/websocket/handlers.go; then
          echo "❌ Test changes NOT found in git!"
          exit 1
        fi
        echo "✅ Test changes found in git!"
        
        # Create completely isolated build environment
        echo "=== Creating isolated build environment ==="
        BUILD_DIR="/tmp/servereye-build-$(date +%s)"
        mkdir -p $BUILD_DIR
        cp -r . $BUILD_DIR/
        cd $BUILD_DIR
        
        # Verify files copied correctly
        if ! grep -q "CI/CD TEST" internal/websocket/handlers.go; then
          echo "❌ Test changes NOT found in build directory!"
          exit 1
        fi
        echo "✅ Test changes found in build directory!"
        
        # FORCE CHANGE THE FILE TO BREAK ANY CACHING
        echo "=== Force changing handlers.go to break caching ==="
        echo "// FORCE REBUILD $(date +%s)" >> internal/websocket/handlers.go
        echo "✅ File timestamp and content changed!"
        
        # Verify the change was made
        if ! grep -q "FORCE REBUILD" internal/websocket/handlers.go; then
          echo "❌ Force rebuild comment NOT found!"
          exit 1
        fi
        echo "✅ Force rebuild comment verified!"
        
        # Force rebuild everything
        echo "=== Building Docker image ==="
        docker system prune -a -f
        docker builder prune -a -f
        
        # Build with explicit context and no caching
        docker build \
          --no-cache \
          --pull \
          --force-rm \
          --build-arg BUILD_DATE=${{ env.BUILD_DATE }} \
          --build-arg VERSION=${{ env.VERSION }} \
          --build-arg COMMIT_SHA=${{ env.COMMIT_SHA }} \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$UNIQUE_TAG \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          .
        
        # Verify the build
        echo "=== Verifying built image ==="
        
        # Check for FORCE REBUILD comment first - check in source code copied to image
        if ! docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$UNIQUE_TAG test -f /app/internal/websocket/handlers.go || ! docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$UNIQUE_TAG grep -q "FORCE REBUILD" /app/internal/websocket/handlers.go; then
          echo "❌ Force rebuild comment NOT found in source code!"
          echo "Checking if source files exist in image..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$UNIQUE_TAG ls -la /app/internal/websocket/ || echo "Directory not found"
          exit 1
        fi
        echo "✅ Force rebuild comment found in source code!"
        
        # Check for CI/CD TEST in source code
        if ! docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$UNIQUE_TAG grep -q "CI/CD TEST" /app/internal/websocket/handlers.go; then
          echo "❌ CI/CD TEST NOT found in source code!"
          echo "Checking source files..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$UNIQUE_TAG grep -n "TEST" /app/internal/websocket/handlers.go || echo "No TEST found"
          exit 1
        fi
        echo "✅ CI/CD TEST found in source code!"
        
        # Push all tags
        echo "=== Pushing images ==="
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$UNIQUE_TAG
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        echo "✅ Build and push completed successfully!"

  deploy-production:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/production'
    
    steps:
    - name: Deploy to production
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          # Set environment variables for script
          export PROD_HOST="${{ secrets.PROD_HOST }}"
          export PROD_USER="${{ secrets.PROD_USER }}"
          export PROD_SSH_KEY="${{ secrets.PROD_SSH_KEY }}"
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_NAME="${{ env.IMAGE_NAME }}"
          export GITHUB_SHA="${{ github.sha }}"
          export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export WEBHOOK_SECRET="${{ secrets.WEBHOOK_SECRET }}"
          export WEB_URL="${{ vars.WEB_URL || 'https://api.servereye.dev' }}"
          
          # Download and run deployment script
          curl -fsSL https://raw.githubusercontent.com/godofphonk/ServerEyeAPI/production/scripts/deploy-production.sh -o /tmp/deploy-production.sh
          chmod +x /tmp/deploy-production.sh
          /tmp/deploy-production.sh
